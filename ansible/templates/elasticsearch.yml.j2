# Elasticsearch Configuration
# Generated by Ansible for {{ inventory_hostname }}

# Cluster Configuration
cluster.name: {{ elasticsearch_cluster_name | default('diplom-elk-cluster') }}
node.name: {{ elasticsearch_node_name | default(inventory_hostname) }}
node.roles: {{ elasticsearch_node_roles | default(['master', 'data', 'ingest']) | to_json }}

# Paths
path.data: {{ elasticsearch_data_path | default('/var/lib/elasticsearch') }}
path.logs: {{ elasticsearch_logs_path | default('/var/log/elasticsearch') }}
path.repo: {{ elasticsearch_repo_path | default('/var/lib/elasticsearch/backups') }}

# Network Configuration
network.host: {{ elasticsearch_network_host | default('0.0.0.0') }}
http.host: {{ elasticsearch_http_host | default('0.0.0.0') }}
http.port: {{ elasticsearch_http_port | default(9200) }}
transport.host: {{ elasticsearch_transport_host | default('0.0.0.0') }}
transport.port: {{ elasticsearch_transport_port | default(9300) }}

# Discovery Configuration
{% if elasticsearch_cluster_nodes is defined and elasticsearch_cluster_nodes | length > 1 %}
discovery.seed_hosts: {{ elasticsearch_cluster_nodes | to_json }}
cluster.initial_master_nodes: {{ elasticsearch_master_nodes | default(elasticsearch_cluster_nodes) | to_json }}
{% else %}
discovery.type: single-node
{% endif %}

# Security Configuration
xpack.security.enabled: {{ elasticsearch_security_enabled | default(false) }}
xpack.security.enrollment.enabled: {{ elasticsearch_enrollment_enabled | default(false) }}
xpack.security.http.ssl.enabled: {{ elasticsearch_http_ssl_enabled | default(false) }}
xpack.security.transport.ssl.enabled: {{ elasticsearch_transport_ssl_enabled | default(false) }}

{% if elasticsearch_security_enabled | default(false) %}
# SSL Configuration
xpack.security.http.ssl.keystore.path: {{ elasticsearch_ssl_keystore_path | default('/etc/elasticsearch/certs/elastic-certificates.p12') }}
xpack.security.transport.ssl.keystore.path: {{ elasticsearch_ssl_keystore_path | default('/etc/elasticsearch/certs/elastic-certificates.p12') }}
xpack.security.transport.ssl.truststore.path: {{ elasticsearch_ssl_truststore_path | default('/etc/elasticsearch/certs/elastic-certificates.p12') }}
xpack.security.transport.ssl.verification_mode: certificate
{% endif %}

# Memory and Performance
bootstrap.memory_lock: {{ elasticsearch_memory_lock | default(true) }}

# JVM Heap Size (set via environment variables)
# ES_JAVA_OPTS: "-Xms{{ elasticsearch_heap_size | default('1g') }} -Xmx{{ elasticsearch_heap_size | default('1g') }}"

# Thread Pool Configuration
thread_pool:
  write:
    size: {{ elasticsearch_write_thread_pool_size | default(ansible_processor_vcpus) }}
    queue_size: {{ elasticsearch_write_queue_size | default(200) }}
  search:
    size: {{ elasticsearch_search_thread_pool_size | default((ansible_processor_vcpus * 3 / 2) | int + 1) }}
    queue_size: {{ elasticsearch_search_queue_size | default(1000) }}
  get:
    size: {{ elasticsearch_get_thread_pool_size | default(ansible_processor_vcpus) }}
    queue_size: {{ elasticsearch_get_queue_size | default(1000) }}

# Index Configuration
indices.query.bool.max_clause_count: {{ elasticsearch_max_clause_count | default(1024) }}
indices.fielddata.cache.size: {{ elasticsearch_fielddata_cache_size | default('20%') }}
indices.requests.cache.size: {{ elasticsearch_requests_cache_size | default('1%') }}
indices.recovery.max_bytes_per_sec: {{ elasticsearch_recovery_max_bytes_per_sec | default('40mb') }}

# Cluster Routing and Allocation
cluster.routing.allocation.enable: all
cluster.routing.allocation.node_concurrent_recoveries: {{ elasticsearch_concurrent_recoveries | default(2) }}
cluster.routing.allocation.cluster_concurrent_rebalance: {{ elasticsearch_concurrent_rebalance | default(2) }}
cluster.routing.allocation.awareness.attributes: {{ elasticsearch_awareness_attributes | default('') }}

# Disk-based shard allocation
cluster.routing.allocation.disk.threshold_enabled: {{ elasticsearch_disk_threshold_enabled | default(true) }}
cluster.routing.allocation.disk.watermark.low: {{ elasticsearch_disk_watermark_low | default('85%') }}
cluster.routing.allocation.disk.watermark.high: {{ elasticsearch_disk_watermark_high | default('90%') }}
cluster.routing.allocation.disk.watermark.flood_stage: {{ elasticsearch_disk_watermark_flood | default('95%') }}
cluster.info.update.interval: {{ elasticsearch_cluster_info_update_interval | default('30s') }}

# Action Configuration
action.destructive_requires_name: {{ elasticsearch_destructive_requires_name | default(true) }}
action.auto_create_index: {{ elasticsearch_auto_create_index | default('+logstash-*,+filebeat-*,+metricbeat-*,-.security*') }}

# Gateway Configuration
gateway.recover_after_nodes: {{ elasticsearch_recover_after_nodes | default(1) }}
gateway.expected_nodes: {{ elasticsearch_expected_nodes | default(1) }}
gateway.recover_after_time: {{ elasticsearch_recover_after_time | default('5m') }}

# HTTP Configuration
http.max_content_length: {{ elasticsearch_http_max_content_length | default('100mb') }}
http.max_initial_line_length: {{ elasticsearch_http_max_initial_line_length | default('4kb') }}
http.max_header_size: {{ elasticsearch_http_max_header_size | default('8kb') }}
http.compression: {{ elasticsearch_http_compression | default(true) }}
http.cors.enabled: {{ elasticsearch_http_cors_enabled | default(false) }}
{% if elasticsearch_http_cors_enabled | default(false) %}
http.cors.allow-origin: {{ elasticsearch_http_cors_allow_origin | default('"*"') }}
http.cors.allow-methods: {{ elasticsearch_http_cors_allow_methods | default('OPTIONS, HEAD, GET, POST, PUT, DELETE') }}
http.cors.allow-headers: {{ elasticsearch_http_cors_allow_headers | default('X-Requested-With, Content-Type, Content-Length') }}
{% endif %}

# Monitoring and Logging
logger.level: {{ elasticsearch_log_level | default('INFO') }}
logger.org.elasticsearch.discovery: {{ elasticsearch_discovery_log_level | default('DEBUG') }}

# Monitoring
xpack.monitoring.enabled: {{ elasticsearch_monitoring_enabled | default(true) }}
xpack.monitoring.collection.enabled: {{ elasticsearch_monitoring_collection_enabled | default(true) }}

# Machine Learning (if available)
xpack.ml.enabled: {{ elasticsearch_ml_enabled | default(false) }}

# Watcher (if available)
xpack.watcher.enabled: {{ elasticsearch_watcher_enabled | default(false) }}

# Graph (if available)
xpack.graph.enabled: {{ elasticsearch_graph_enabled | default(false) }}

# SQL (if available)
xpack.sql.enabled: {{ elasticsearch_sql_enabled | default(true) }}

# Rollup (if available)
xpack.rollup.enabled: {{ elasticsearch_rollup_enabled | default(true) }}

# Index Lifecycle Management
xpack.ilm.enabled: {{ elasticsearch_ilm_enabled | default(true) }}

# Snapshot and Restore
repositories.url.allowed_urls: {{ elasticsearch_allowed_urls | default('["http://*", "https://*"]') | to_json }}