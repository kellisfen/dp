# Zabbix Agent Configuration
# Generated by Ansible for {{ inventory_hostname }}

# Basic Settings
PidFile=/run/zabbix/zabbix_agentd.pid
LogFile=/var/log/zabbix/zabbix_agentd.log
LogFileSize=100
DebugLevel={{ zabbix_debug_level | default(3) }}
LogType=file

# Server Configuration
Server={{ zabbix_server_ip | default(zabbix_agent_server) }}
ServerActive={{ zabbix_server_ip | default(zabbix_agent_server_active) }}
Hostname={{ zabbix_agent_hostname | default(inventory_hostname) }}
HostnameItem=system.hostname

# Performance Settings
RefreshActiveChecks={{ zabbix_refresh_active_checks | default(120) }}
BufferSend={{ zabbix_buffer_send | default(5) }}
BufferSize={{ zabbix_buffer_size | default(100) }}
MaxLinesPerSecond={{ zabbix_max_lines_per_second | default(20) }}
StartAgents={{ zabbix_start_agents | default(3) }}

# Security Settings
AllowRoot=0
User=zabbix
AllowKey=system.run[*]

# Include additional configuration files
Include=/etc/zabbix/zabbix_agentd.d/*.conf

# User Parameters for USE Monitoring (Utilization, Saturation, Errors)
UnsafeUserParameters=0

# CPU Utilization
UserParameter=cpu.util.user,grep 'cpu ' /proc/stat | awk '{print ($2*100)/($2+$3+$4+$5+$6+$7+$8)}'
UserParameter=cpu.util.system,grep 'cpu ' /proc/stat | awk '{print ($4*100)/($2+$3+$4+$5+$6+$7+$8)}'
UserParameter=cpu.util.idle,grep 'cpu ' /proc/stat | awk '{print ($5*100)/($2+$3+$4+$5+$6+$7+$8)}'
UserParameter=cpu.util.iowait,grep 'cpu ' /proc/stat | awk '{print ($6*100)/($2+$3+$4+$5+$6+$7+$8)}'

# Memory Utilization
UserParameter=memory.util.used,free | grep Mem | awk '{print ($3/$2)*100}'
UserParameter=memory.util.available,free | grep Mem | awk '{print ($7/$2)*100}'
UserParameter=memory.util.buffers,free | grep Mem | awk '{print ($6/$2)*100}'
UserParameter=memory.util.cached,free | grep Mem | awk '{print ($6/$2)*100}'

# Disk I/O Utilization and Saturation
UserParameter=disk.io.read.ops[*],cat /proc/diskstats | grep -w $1 | awk '{print $$4}'
UserParameter=disk.io.read.ms[*],cat /proc/diskstats | grep -w $1 | awk '{print $$7}'
UserParameter=disk.io.write.ops[*],cat /proc/diskstats | grep -w $1 | awk '{print $$8}'
UserParameter=disk.io.write.ms[*],cat /proc/diskstats | grep -w $1 | awk '{print $$11}'
UserParameter=disk.io.util[*],cat /proc/diskstats | grep -w $1 | awk '{print $$13}'

# Network Utilization
UserParameter=net.if.bytes.in[*],cat /proc/net/dev | grep $1 | awk '{print $$2}'
UserParameter=net.if.bytes.out[*],cat /proc/net/dev | grep $1 | awk '{print $$10}'
UserParameter=net.if.packets.in[*],cat /proc/net/dev | grep $1 | awk '{print $$3}'
UserParameter=net.if.packets.out[*],cat /proc/net/dev | grep $1 | awk '{print $$11}'
UserParameter=net.if.errors.in[*],cat /proc/net/dev | grep $1 | awk '{print $$4}'
UserParameter=net.if.errors.out[*],cat /proc/net/dev | grep $1 | awk '{print $$12}'

# System Load (Saturation)
UserParameter=system.load.1min,uptime | awk '{print $(NF-2)}' | sed 's/,//'
UserParameter=system.load.5min,uptime | awk '{print $(NF-1)}' | sed 's/,//'
UserParameter=system.load.15min,uptime | awk '{print $NF}'

# Process Monitoring
UserParameter=proc.count[*],ps aux | grep -c "$1"
UserParameter=proc.memory[*],ps aux | grep "$1" | grep -v grep | awk '{sum += $$6} END {print sum}'
UserParameter=proc.cpu[*],ps aux | grep "$1" | grep -v grep | awk '{sum += $$3} END {print sum}'

# Service-specific monitoring
{% if 'web_servers' in group_names %}
# Nginx monitoring
UserParameter=nginx.status[*],curl -s http://127.0.0.1/nginx_status | grep "$1" | awk '{print $$3}'
UserParameter=nginx.connections.active,curl -s http://127.0.0.1/nginx_status | grep "Active connections" | awk '{print $$3}'
UserParameter=nginx.connections.reading,curl -s http://127.0.0.1/nginx_status | grep "Reading" | awk '{print $$2}'
UserParameter=nginx.connections.writing,curl -s http://127.0.0.1/nginx_status | grep "Writing" | awk '{print $$4}'
UserParameter=nginx.connections.waiting,curl -s http://127.0.0.1/nginx_status | grep "Waiting" | awk '{print $$6}'
{% endif %}

{% if 'monitoring' in group_names %}
# MySQL monitoring for Zabbix
UserParameter=mysql.status[*],mysqladmin -uzabbix -p{{ zabbix_db_password }} status | grep "$1" | awk '{print $$2}'
UserParameter=mysql.ping,mysqladmin -uzabbix -p{{ zabbix_db_password }} ping | grep -c "mysqld is alive"
{% endif %}

{% if 'logging' in group_names %}
# Elasticsearch monitoring
UserParameter=elasticsearch.cluster.health,curl -s http://127.0.0.1:9200/_cluster/health | jq -r '.status'
UserParameter=elasticsearch.nodes.total,curl -s http://127.0.0.1:9200/_cluster/health | jq '.number_of_nodes'
UserParameter=elasticsearch.indices.count,curl -s http://127.0.0.1:9200/_cat/indices | wc -l
{% endif %}

# File system monitoring
UserParameter=fs.size[*],df -B1 $1 | tail -1 | awk '{print $$2}'
UserParameter=fs.used[*],df -B1 $1 | tail -1 | awk '{print $$3}'
UserParameter=fs.free[*],df -B1 $1 | tail -1 | awk '{print $$4}'
UserParameter=fs.pused[*],df $1 | tail -1 | awk '{print $$5}' | sed 's/%//'

# Log monitoring
UserParameter=log.count[*],grep -c "$2" $1 2>/dev/null || echo 0
UserParameter=log.error.count[*],grep -ci "error\|critical\|fatal" $1 2>/dev/null || echo 0

# Connection and timeout settings
Timeout={{ zabbix_timeout | default(3) }}
ListenPort={{ zabbix_agent_port | default(10050) }}
ListenIP=0.0.0.0